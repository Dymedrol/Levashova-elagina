<div class="product-page">
  <h1 class="product-title">{{ product.title }}</h1>

  {% if product.images.size > 0 %}
    <div class="product-gallery">
      {% for image in product.images %}
        <img src="{{ image.medium_url }}" alt="{{ product.title }}" class="product-image" />
      {% endfor %}
    </div>
  {% endif %}

  <div class="product-info">
    <div class="product-sku">
      Артикул: <span id="product-sku">
        {% if product.variants.size > 0 %}
          {{ product.variants.first.sku }}
        {% endif %}
      </span>
    </div>
    <div id="product-price">
      <span>
        {% if product.variants.size > 0 %}
          {{ product.variants.first.price | money }}
        {% endif %}
      </span>
    </div>

    <form id="add-to-cart-form" action="/cart_items" method="post">
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <input type="hidden" name="variant_id" id="variant_id" value="{{ product.variants.first.id }}">

      {% for option in product.options %}
        <div class="product-option-group" data-option-index="{{ forloop.index0 }}">
          <div class="option-label">{{ option.title }}</div>
          <div class="option-values">
            {% for value in option.values %}
              <button type="button" class="product-option-btn" data-value="{{ value.title | escape | strip }}" data-option-index="{{ forloop.parentloop.index0 }}">
                {{ value.title }}
              </button>
            {% endfor %}
          </div>
        </div>
      {% endfor %}

      <button type="submit" id="buy-btn" class="btn btn-primary">Купить</button>
    </form>
  </div>
</div>

<script>
  // Формируем массив вариантов с option_values
  var variants = [
    {% for variant in product.variants %}
      {
        id: {{ variant.id }},
        options: [{% for v in variant.option_values %}"{{ v.title | escape | strip }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
        price: "{{ variant.price | money }}",
        sku: "{{ variant.sku | escape }}",
        available: {{ variant.available | json }}
      }{% unless forloop.last %}, {% endunless %}
    {% endfor %}
  ];

  var selectedOptions = [];

  document.addEventListener('DOMContentLoaded', function() {
    // Инициализация: выбираем опции первого доступного варианта
    var firstVariant = variants.find(function(v) { return v.available; }) || variants[0];
    if (firstVariant) {
      selectedOptions = firstVariant.options.slice();
      // Сброс выделения у всех кнопок
      document.querySelectorAll('.product-option-btn').forEach(function(btn) {
        btn.classList.remove('selected');
      });
      // Подсветка только тех, что соответствуют выбранным опциям
      document.querySelectorAll('.product-option-group').forEach(function(group, idx) {
        var btns = group.querySelectorAll('.product-option-btn');
        btns.forEach(function(btn) {
          if (btn.getAttribute('data-value').trim() === selectedOptions[idx]) {
            btn.classList.add('selected');
          }
        });
      });
    }

    updateOptionsAndVariant();

    // Обработчик клика по кнопке опции
    document.querySelectorAll('.product-option-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (btn.disabled) return;
        var optionIdx = parseInt(btn.getAttribute('data-option-index'));
        // Снимаем выделение со всех кнопок этой группы
        btn.parentElement.querySelectorAll('.product-option-btn').forEach(function(b) {
          b.classList.remove('selected');
        });
        // Выделяем выбранную
        btn.classList.add('selected');
        selectedOptions[optionIdx] = btn.getAttribute('data-value').trim();
        updateOptionsAndVariant();
      });
    });
  });

  function updateOptionsAndVariant() {
    // Находим выбранный вариант
    var selectedVariant = variants.find(function(variant) {
      return JSON.stringify(variant.options) === JSON.stringify(selectedOptions);
    });

    // Обновляем цену, артикул, variant_id, кнопку
    if (selectedVariant) {
      document.getElementById('variant_id').value = selectedVariant.id;
      document.getElementById('product-price').innerHTML = '<span>' + selectedVariant.price + '</span>';
      document.getElementById('product-sku').textContent = selectedVariant.sku;
      document.getElementById('buy-btn').disabled = !selectedVariant.available;
      document.getElementById('buy-btn').textContent = selectedVariant.available ? 'Купить' : 'Нет в наличии';
    } else {
      document.getElementById('variant_id').value = '';
      document.getElementById('product-price').innerHTML = '<span>—</span>';
      document.getElementById('product-sku').textContent = '';
      document.getElementById('buy-btn').disabled = true;
      document.getElementById('buy-btn').textContent = 'Нет в наличии';
    }
  }
</script>

<style>
.product-option-btn.selected {
  background: #007bff;
  color: #fff;
}
.product-option-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.product-gallery {
  display: flex;
  gap: 10px;
  margin-bottom: 1em;
}
.product-image {
  max-width: 120px;
  border: 1px solid #eee;
  border-radius: 4px;
}
.product-sku {
  margin-bottom: 0.5em;
  color: #888;
}
</style>
